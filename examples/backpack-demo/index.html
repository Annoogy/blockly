<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Blockly Demo: Backpack</title>
  <script src="./node_modules/blockly/blockly_compressed.js"></script>
  <script src="./node_modules/blockly/blocks_compressed.js"></script>
  <script src="./node_modules/blockly/msg/en.js"></script>
  <script src="./node_modules/@blockly/workspace-backpack/dist/index.js"></script>
  <style>
    body {
      background-color: #fff;
      font-family: sans-serif;
    }
    h1 {
      font-weight: normal;
      font-size: 140%;
    }
  </style>
</head>
<body>
<p>This is a simple demo of two Blockly instances sharing a common Backpack.</p>

<table width="100%">
  <tr>
    <td>
      <div id="primaryDiv" style="height: 480px; width: 600px;"></div>
    </td>
    <td>
      <div id="secondaryDiv" style="height: 480px; width: 600px;"></div>
    </td>
  </tr>
</table>

<xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
  <block type="controls_if"></block>
  <block type="logic_compare"></block>
  <block type="controls_repeat_ext"></block>
  <block type="math_number">
    <field name="NUM">123</field>
  </block>
  <block type="math_arithmetic"></block>
  <block type="text"></block>
  <block type="text_print"></block>
  <block type="variables_get"><field name="VAR">i</field></block>
  <block type="variables_get"><field name="VAR">j</field></block>
  <block type="variables_get"><field name="VAR">k</field></block>
</xml>

<script>
  // Inject primary workspace.
  var primaryWorkspace = Blockly.inject('primaryDiv',
      {
        media: 'https://unpkg.com/blockly/media/',
        toolbox: document.getElementById('toolbox'),
        trashcan: true,
      });
  // Inject secondary workspace.
  var secondaryWorkspace = Blockly.inject('secondaryDiv',
      {
        media: 'https://unpkg.com/blockly/media/',
        toolbox: document.getElementById('toolbox'),
        trashcan: true
      });

  // Add backpacks
  const backpack1 = new Backpack(primaryWorkspace);
  backpack1.init();
  const backpack2 = new Backpack(secondaryWorkspace);
  backpack2.init();

  // Listen to events on both workspace.
  primaryWorkspace.addChangeListener(updateBackpack);
  secondaryWorkspace.addChangeListener(updateBackpack);

  function updateBackpack(event) {
    if (event.type !== 'backpack_change') {
      return;
    }
    Blockly.Events.disable();
    let contents;
    let targetBackpack;
    if (primaryWorkspace.id === event.workspaceId) {
      targetBackpack = secondaryWorkspace.backpack;
      contents = primaryWorkspace.backpack.getContents();
      console.log('second workspace backpack updated');
    } else { // secondaryWorkspace.id === event.workspaceId
      targetBackpack = primaryWorkspace.backpack;
      contents = secondaryWorkspace.backpack.getContents();
      console.log('first workspace backpack updated');
    }
    targetBackpack.setContents(contents);
    Blockly.Events.enable();
  }
</script>

</body>
</html>
